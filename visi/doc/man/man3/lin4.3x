.TH LIN4 3x LINLIB
.SH ИМЯ
lin4 \- БИБЛИОТЕКА LINLIB, ФУНКЦИИ УРОВНЯ ПОЛЬЗОВАТЕЛЯ
.SH
.ES
 +----------+   БИБЛИОТЕКА ВВОДА-ВЫВОДА
(c) linlib  !   ДЛЯ АЛФАВИТНО-ЦИФРОВЫХ
 +----------+   ВИДЕОТЕРМИНАЛОВ
.EE
.SH ФОРМАТ
.ES 5

#include <stdio.h>
#include "line.h"

int
cvt_a(line, cod, mod, str)
LINE *line;
kbcod   cod;
char   *mod;
char   *str;

int
cvt_lh(line, cod, mod, str)
LINE *line;
kbcod   cod;
char   *mod;
char   *str;

clock(li, co, at)  /* ЧАСЫ, включить индикацию */
int  li, co, at;

clock( 0,  0, -1)  /* ЧАСЫ, выключить индикацию */

tst_m(line, cod)
LINE *line;
kbcod  cod;

w_emsg( str )   /* ВЫВЕСТИ СООБЩЕНИЕ */
char  *str;

w_emsg( "" )    /* ПОГАСИТЬ СООБЩЕНИЕ */

#include "linebp.h"

char    *b_pgnm;

LINE *
b_page(libnam, fnam, ports)
char *libnam;
char *fnam;
IN_PORTS *ports;

d_page(line)
LINE *line;

.EE
.SH ОПИСАНИЕ
Функции этой группы носят необязательный характер,
поьзователь сам может писать функции прикладного уровня,
такие как cvt_a(), clock(), help().

.SS "cvt_a - стандартное управление переключателем"
Переключатель - это такая переменная, которая может
принимать строго фиксированный набор значений, каждое из
которых допустимо использовать в качестве индекса массива.
Во внешнем представлении каждому значению
индекса соответствует строка символов, выводимая на экран.
Диапазон изменения переключателя (0...N) определяется
длиной массива указателей на строки, завершающийся
нулем.
.PP
Функция вызывается как функция форматного преобразования,
из функций r_line/w_line (см. lin3(3x)).
При описании линии необходимо в поле attr задать атрибут
LALT, в поле varl - адрес переключателя,
в поле cvts - адрес массива указателей на строки внешнего
представления. Последнее возможно, поскольку значение
поля cvts игнорируется функциями r_line/w_line, если
поле cvtf  не равно нулю.
.PP
Аргументы функций форматного преобразования:
.JP line
Указатель на линию, для которой вызвана функция;
.JP cod
Код последней нажатой клавиши;
.JP mod
Указатель на строку сумволов, содержащую "w", если функция
вызвана для форматного преобразования на выводе, и "r", если на вводе;
.JP str
Указатель на строку, куда помещать результат форматного
преобразования (w_line), или откуда брать текст для
форматного преобразования на ввод (r_line).
.SS "cvt_lh - подставить название клавиши"
Функция используется в основном системой visi(3x), для
оформления страниц со справочной информацией. При необхоодимости
может быть использована явно, при описании линии. Адрес функции подставляется
в поле cvtf, в поле varl подставляется указатель на строку ЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪЪвида
.EX ":NL"
которая содержит две буквы кода клавиши, см. файл "line.h".
Если код названия клавиши не найден, то будет выведен текст
после символа ":".
.SS "clock - часы"
функция запускает часы с индикацией в указанном месте экрана.
Функция использует механизм асинхронных заданий
(см. ajobs(3x)), позволяет наблюдать время суток
при работе программы, не мешая основному диалогу.
Смена индикации происходит не чаще, чем раз в секунду,
но если не установлен режим ввода/вывода
IO_NOWAIT (см. описание io_set, line1(3x)),
то смена индикации
может происходить только в момент нажатия
какой-либо клавиши.
.PP
Аргументы функции clock совпадают по формату с аргументами функции
cp_set (см. lin2(3x)). Это координаты начала строки длиной
восемь символов вида
.EX "ЧЧ:мм'СС"
.PP
Выключить индикацию можно, вызвав функцию с аргументом
.EX at = -1,
в этом случае два других параметра не играют роли.

.SS "tst_m"
Функция для организации меню, указывается при описании линии
в поле test. В поле varl помещается указатель на строку, которая
будет на экране в поле данной линии, в одном из полей линии,
либо cvts, либо cvtf, указывается что нужно сделать, если
выбран этот пункт меню. В поле cvtf помещается указатель на функцию
этой же программы, в поле cvts - указатель на строку символов,
содержащую команду для функции system(2), выполняемую интерпретатором
shell. В последнем случае на время выполнения команды
восстанавливаются стандартные режимы драйвера терминала
при помощи функции io_set, см. lin2(3x).

.SS "w_emsg - выдать сообщение об ошибке"
Достаточно часто приходится выдавать различные
диагностические сообщения, лучше всего их помещать в определенном месте
экрана, для чего и предназначена эта функция.
.PP
Функция имеет один аргумент - указатель на строку сообщения об
ошибке. Текст немедленно выводится в последней строке
экрана, начиная с 0-й позиции.
.PP
Для стирания последнего сообщения нужно вызвать функцию
с аргументом "пустая строка".
.SS "b_page - Builde PAGE - построить страницу"
Функция b_page() используется для создания структуры
данных, описывающей страницу (это массив типа LINE) по
ее внешнему описанию, хранящемуся в отдельном файле.
В совокупности с препроцессором vlbp(1) и компилятором lbp(1)
функция b_page позволяет отделить описание страницы от
программы, и производить "косметические" исправления
без перетрансляции основных текстов программы.
.PP
Функция b_page()  возвращает указатель на страницу. При этом
запрашивается память
с помощью функции malloc(), а описание считывается из внешнего файла.
В случае неудачи функция возвращает NULL.
.PP
Работа со страницей, построенной при помощи b_page(),
ничем не отличается от работы со страницей,
описанной статически в исходных текстах самой
программы, включая тонкости работы с таблицами.
Функция b_page() принимает несколько аргументов:
.JP libnm
Указатель на строку с именем библиотеки форм -
В ОС ДЕМОС это имя каталога(от текущего либо от корня),
с символом '/' на конце,
а в ОС RT-11 - логическое имя диска,
включая ':'.
.JP pagnm
Имя файла, содержащего описание требуемой страницы,
подготовленное при помощи программы lbp (см. lbp(1)).
.JP ad_tab
Указатель на таблицу адресов, связанных со страницей.
Таблица адресов состоит из пар указателей на имя и переменную,
в конце ставится пара нулей.
Имя - это строка в символьном коде до 6 символов длиной, по которой
будет подставлен указатель на переменную вместо такого же
имени во внешнем описании.
.PP
Такой способ позволяет легко именовать адреса элементов
структур, и другие данные, а также обладает
достаточной степенью переносимости, в
отличие от поиска в namelist (см. a.out(5)).

.SS "d_page - Destroy PAGE - уничтожить страницу"
Функция освобождает (с помощью free, см. malloc(3))
память, ранее занятую через вызов функции b_page().
В качестве аргумента принимает значение, полученное
при вызове b_page().

.SH ФАЙЛЫ
.ES
/usr/line/*/*.lb        ДЕМОС
LIN:*.LB                RT-11
.EE
внешние описания страниц, подготовленных для
вызова из программ;
.ES
/usr/bin/lbp            ДЕМОС
SY:LBP.SAV              RT-11
.EE
Программа подготовки внешних описаний страниц;
.ES
*.la                    ДЕМОС
*.LA                    RT-11
.EE
Исходные тексты внешних описаний страниц;
.SH ДОПОЛНИТЕЛЬНЫЕ ССЫЛКИ
stdio(2), ldemo(1), linlib(3x), lin1(3x), lin2(3x), lin3(3x), ajobs(3x),
ctime(3), malloc(3), a.out(5), system(2).
.SH ДИАГНОСТИКА
Об'ем диагностики выбирается в каждом случае из каких-либо
достаточно здравых соображений. В любом случае не стоит
перегружать исполняющие библиотеки длинными сообщениями
об ошибках. Например, наиболее частая ошибка при работе
с внешними страницами - путаница с именами, по которым
подставляются связи с переменными программы. В демонстрационной
про